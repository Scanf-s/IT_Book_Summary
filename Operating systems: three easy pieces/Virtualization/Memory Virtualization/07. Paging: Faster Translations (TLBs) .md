## 소개

기존 방식이 너무 느려서 나온 방법이 바로 하드웨어를 사용하는 것입니다. 
즉, **MMU의 TLB(Translation Lookaside Buffer)를 사용**해 캐싱을 추가하는 것이죠. 하드웨어가 주소 변환을 계산하기 전에 **TLB**를 먼저 확인하는 방식입니다.

## TLB 기본 동작 과정

1. 가상 주소에서 **VPN**(Virtual Page Number)을 추출하여 해당 VPN이 TLB에 들어있는지 확인합니다.
2. **TLB Hit**가 발생하면, **PFN**(Physical Frame Number)을 바로 매핑시켜서 원하는 물리 주소를 구성하고 메모리에 접근합니다.
3. **TLB Miss**가 발생하면, 페이지 테이블을 통해 변환 정보를 찾아야 하므로 **페이지 테이블 주소**로 접근하여 계산해야 하며, 이 과정은 시간이 많이 걸립니다.

즉, **TLB Hit** 시에는 매우 빠르게 동작하지만, **TLB Miss** 시에는 다소 비효율적이 됩니다.

## 예시

![image](https://github.com/user-attachments/assets/366924a4-60b4-458b-8b87-5d45cbbbf67e)

초기화된 TLB가 있다고 가정합니다. 배열 `a`의 첫 번째 요소 **a[0]**에 접근하려고 하면 **TLB Miss**가 발생하여 페이지 테이블을 방문하고, 실제 주소를 계산한 후 해당 정보를 **TLB에 갱신**합니다. 이후 **a[1]**, **a[2]**에 접근하면 **TLB Hit**가 발생하여 **PFN**을 바로 사용해 물리 주소를 계산하여 접근할 수 있습니다.

이와 같이, `a[3]`에서 **TLB Miss**가 발생하지만, 이후 **a[4]**, **a[5]**, **a[6]**, **a[7]**에서는 **TLB Hit**가 발생합니다. 이러한 방식으로 TLB가 동작하여 효율성을 높입니다.

## 공간 지역성 / 시간 지역성

- **공간 지역성**: 배열을 처음 접근했을 때는 **Miss**가 발생하지만, 그 근처의 요소에 다시 접근할 경우 **Hit**의 이득을 볼 수 있습니다.
- **시간 지역성**: 한 번 참조한 데이터는 짧은 시간 내에 다시 참조될 가능성이 높습니다.

## TLB Miss 처리 방법

> **TLB Miss**는 하드웨어가 처리합니다. 운영체제를 신뢰할 수 없기 때문입니다.

1. **TLB Miss**가 발생하면, **하드웨어 예외 시그널**이 생성됩니다.
2. 프로세스 명령어 실행이 중지되고, 현재 **프로그램 카운터(PC)** 값이 저장됩니다.
3. **커널 모드**로 전환하여 **트랩 핸들러**가 실행됩니다.
4. **TLB Miss**를 처리하여 **TLB**를 갱신하고, 저장된 **PC** 값을 사용해 프로세스를 다시 진행합니다.

## TLB 사용 시 문맥 교환 문제

> **TLB**에 있는 **VPN**과 **PFN** 정보는 해당 프로세스에서만 유효합니다. 다른 프로세스에서는 의미가 없습니다.

![image](https://github.com/user-attachments/assets/9b1921a3-0f6c-4a15-a402-525f561d6e55)
서로 다른 프로세스가 동일한 **VPN**과 **PFN** 정보를 매핑하면 **충돌**이 발생할 수 있습니다. 이를 방지하기 위해 **추가적인 정보**를 넣어줍니다.

### 방법 1: Valid Bit를 0으로 설정
- **문맥 교환** 시 **TLB**를 초기화하여 **유효 비트(Valid Bit)**를 0으로 설정해 충돌을 방지합니다.
- 하지만, 이 경우 다시 돌아온 프로세스에서 무조건 **TLB Miss**가 발생하므로 효율적이지 않습니다.

### 방법 2: 추가 정보 사용

![image](https://github.com/user-attachments/assets/a5f42f47-e2ce-4823-916e-be6e45528397)

- **PID**(Process ID)처럼, **TLB 테이블**에 **ASID(Address Space Identifier)** 필드를 추가하여 어떤 프로세스의 정보를 기록한 것인지 명확히 합니다.
- 이 방법을 사용하면 문맥 교환이 일어나도 TLB 충돌을 방지할 수 있습니다.

## TLB 용량 문제

**TLB**도 하드웨어이기 때문에 용량이 작아 기존 정보를 지속적으로 교체해야 합니다. **교체 정책**은 다음과 같은 기준을 사용할 수 있습니다:

- **LRU (Least Recently Used)**: 가장 오래 사용되지 않은 항목부터 교체합니다.
- **Random**: 무작위로 항목을 교체합니다.

